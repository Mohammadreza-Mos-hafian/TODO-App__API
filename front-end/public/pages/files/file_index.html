<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="shortcut icon"
      href="../../images/icons/favicon.png"
      type="image/x-icon"
    />
    <link rel="stylesheet" href="../../css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../css/font.css" />
    <link rel="stylesheet" href="../../css/app.css" />

    <title>Task Management | Files</title>
  </head>
  <body>
    <header class="header">
      <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container justify-content-between">
          <h4 class="app_name text-white">
            <a href="http://localhost:3000/public/pages/dashboard.html"
              >Task Management</a
            >
          </h4>
          <div class="d-flex align-items-center justify-content-center gap-2">
            <span class="user-name text-white fs-6"></span>

            <button
              type="button"
              class="btn text-bg-danger btn-sm"
              id="logoutBtn"
            >
              <img
                src="../../images/icons/turn_off.svg"
                alt="Turn off"
                title="Logout"
              />
            </button>
          </div>
        </div>
      </nav>
    </header>

    <div class="container mt-5">
      <h3 class="text-center mb-4">
        Task Files : <span class="text-primary fs-4" id="taskName"></span>
      </h3>

      <div class="alert alert-danger d-none" role="alert"></div>

      <div class="card shadow-sm p-4">
        <div class="d-flex justify-content-end align-items-center mb-1">
          <a href="../tasks/task_index.html" class="btn btn-secondary btn-sm"
            >Back to tasks</a
          >
        </div>

        <table class="table table-striped text-center table-dark">
          <thead>
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Actions</th>
            </tr>
          </thead>

          <tbody>
            <tr class="d-none" id="hiddenRow">
              <td colspan="5" class="text-danger">No Files Found</td>
            </tr>
          </tbody>
        </table>

        <div>
          <ul class="pagination justify-content-center" id="pagination"></ul>
        </div>

        <div class="mt-4">
          <div class="d-flex justify-content-center align-items-center mb-1">
            <h6 class="card-title">Add new files</h6>
          </div>
          <form
            enctype="multipart/form-data"
            class="d-flex align-items-center"
            id="uploadFileForm"
          >
            <input
              type="file"
              name="files[]"
              class="form-control me-2"
              id="files"
              multiple="multiple"
            />

            <button type="submit" class="btn btn-primary">Upload</button>
          </form>

          <span class="text-danger error-message"></span>
        </div>
      </div>
    </div>

    <footer class="text-center mt-5">
      <p>
        &copy;<span class="year"></span> Task Management | All rights reserved.
      </p>
    </footer>

    <script src="../../js/bootstrap.bundle.min.js"></script>
    <script src="../../js/app.js"></script>
    <script type="module">
      import {
        showUserName,
        apiRequest,
        showResult,
        loadData,
        showErrorMessages,
        refreshErrors,
      } from "../../js/utils.js";

      const form = document.getElementById("uploadFileForm");
      const alertElem = document.querySelector(".alert");

      const params = new URLSearchParams(window.location.search);
      const taskUuid = params.get("uuid");

      const tableBody = document.querySelector("tbody");

      document.addEventListener("DOMContentLoaded", () => {
        showUserName();

        if (
          !localStorage.getItem("access_token") &&
          !localStorage.getItem("refresh_token")
        ) {
          setTimeout(() => {
            window.location.assign("http://localhost:3000/public/index.html");
          }, 500);
          return;
        }

        loadData(1, 5, "files");
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        refreshErrors();

        const formData = new FormData(form);
        formData.append("uuid", taskUuid);

        try {
          const response = await apiRequest("http://localhost:5000/api/files", {
            method: "POST",
            body: formData,
          });

          if (response.data.status === "error") {
            showErrorMessages(response.data.errors);
          } else if (
            response.data.status === "DB Error" ||
            response.data.status === "Upload Error"
          ) {
            alertElem.textContent = response.data.errors;
            alertElem.classList.remove("d-none");
          } else {
            setTimeout(() => {
              window.location.assign(
                `http://localhost:3000/public/pages/files/file_index.html?uuid=${taskUuid}`
              );
            }, 500);
          }
        } catch (err) {
          console.error("Unexpected error:", err);
          alertElem.textContent = "An unknown error has occurred.";
          alertElem.classList.remove("d-none");
        }
      });

      tableBody.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          e.preventDefault();

          const fileUuid = e.target.dataset.fileUuid;

          try {
            const response = await apiRequest(
              `http://localhost:5000/api/files/${fileUuid}`,
              {
                method: "DELETE",
              }
            );

            if (response.status === "success") {
              setTimeout(() => {
                window.location.reload();
              }, 500);
            } else {
              console.error("DB Errors:", response.errors);
              alertElem.textContent = response.data.errors;
              alertElem.classList.remove("d-none");
            }
          } catch (err) {
            console.error("Unexpected error:", err);
          }
        }

        if (e.target.classList.contains("download-btn")) {
          e.preventDefault();

          const fileUuid = e.target.dataset.fileUuid;

          try {
            const response = await fetch(
              `http://localhost:5000/api/files/${fileUuid}/download`,
              {
                method: "GET",
                headers: {
                  Authorization:
                    "Bearer " + localStorage.getItem("access_token"),
                },
              }
            );

            const contentType = response.headers.get("content-type");

            if (contentType && contentType.includes("application/json")) {
              const data = await response.json();
              alertElem.textContent = data.errors || "Unknown error";
              alertElem.classList.remove("d-none");
            } else {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;

              const contentDisposition =
                response.headers.get("Content-Disposition") || "";
                
              let filename = "downloaded_file";

              const filenameStarMatch = contentDisposition.match(
                /filename\*\=UTF-8''(.+)/
              );
              if (filenameStarMatch) {
                filename = decodeURIComponent(filenameStarMatch[1]);
              } else {
                const match = contentDisposition.match(/filename="?([^"]+)"?/);
                if (match && match[1]) filename = match[1];
              }

              a.download = filename;
              document.body.appendChild(a);
              a.click();
              a.remove();
              window.URL.revokeObjectURL(url);
            }
          } catch (err) {
            console.error("Unexpected error:", err);
          }
        }
      });
    </script>
  </body>
</html>
